# scVAT 管道测试示例

本文档提供简单的测试示例来验证 long-read 和 short-read 模式是否正常工作。

## 快速开始

### 方法 1: 使用快速测试脚本（推荐）

```bash
# 快速验证工作流结构（不运行实际数据）
./quick_test.sh
```

这个脚本会：
- 检查 Nextflow 和 VAT 是否安装
- 验证 long-read 和 short-read 工作流结构
- 生成工作流 DAG 图

### 方法 2: 使用完整测试脚本

```bash
# 测试两种模式
./test_longread_shortread.sh both

# 只测试 long-read 模式
./test_longread_shortread.sh long_read

# 只测试 short-read 模式
./test_longread_shortread.sh short_read
```

## 手动测试

### 测试 Long-Read 模式

```bash
nextflow run . \
    -profile test_longread,docker \
    --outdir test_output/longread
```

**配置说明：**
- `input_type = 'long_read'`
- 使用 BLAZE 进行 barcode 检测
- 使用 VAT 进行长读段比对
- 使用现有的 nf-core 测试数据集

### 测试 Short-Read 模式

```bash
nextflow run . \
    -profile test_shortread,docker \
    --outdir test_output/shortread
```

**配置说明：**
- `input_type = 'short_read'`
- 使用 UMI-tools whitelist 进行 barcode 检测
- 使用 UMI-tools extract 将 barcode/UMI 移到 Read ID
- 使用 VAT 进行短读段比对
- 强制使用 UMI-tools dedup（不能跳过）

## 测试配置文件位置

- Long-read 测试配置: `conf/test_longread.config`
- Short-read 测试配置: `conf/test_shortread.config`
- 测试脚本: `test_longread_shortread.sh`
- 快速测试脚本: `quick_test.sh`

## 预期输出

### Long-Read 模式输出

```
test_output/longread/
├── vat/                    # VAT 比对结果
├── barcode_tagged/         # 带 barcode 标签的 BAM 文件
├── dedup_umitools/         # 去重后的 BAM 文件
├── isoquant/               # 基因/转录本计数矩阵
└── multiqc/                # MultiQC 报告
```

### Short-Read 模式输出

```
test_output/shortread/
├── umitools_whitelist/     # 有效 barcode 白名单
├── umitools_extract/       # 带 barcode/UMI 的 Read ID 的 FASTQ
├── vat/                    # VAT 比对结果
├── barcode_tagged/         # 带 CB 和 UB 标签的 BAM 文件
├── dedup_umitools/         # 去重后的 BAM 文件（必需）
├── isoquant/               # 基因/转录本计数矩阵
└── multiqc/                # MultiQC 报告
```

## 验证检查点

运行测试后，检查以下内容：

1. **工作流执行报告**: `test_output/*/pipeline_info/execution_report.html`
2. **MultiQC 报告**: `test_output/*/multiqc/multiqc_report.html`
3. **BAM 文件标签**: 检查是否包含 barcode 标签
   - Long-read: CR, CY, UR, UY, CB
   - Short-read: CB (Corrected Barcode), UB (Corrected UMI)
4. **计数矩阵**: 验证基因/转录本计数是否生成

## 常见问题

### VAT 二进制文件未找到

```bash
# 检查 VAT 是否存在
ls -lh bin/VAT

# 使其可执行
chmod +x bin/VAT

# 或确保 VAT 在 PATH 中
which VAT
```

### Short-Read 测试数据问题

Short-read 测试需要配对的 FASTQ 文件。如果测试数据不可用：

1. 使用自己的测试数据
2. 更新 `assets/samplesheet/samplesheet_shortread_test.csv` 中的文件路径
3. 或先使用 long-read 测试（有可用的测试数据）

### 容器问题

如果遇到容器问题，尝试：

```bash
# 使用 singularity 而不是 docker
nextflow run . -profile test_longread,singularity --outdir test_output

# 或使用 conda
nextflow run . -profile test_longread,conda --outdir test_output
```

## 注意事项

- 测试配置使用最小资源（4 CPUs, 15GB RAM）以便快速测试
- 生产环境运行需要调整配置文件中的资源设置
- Short-read 模式需要 UMI-tools dedup（不能跳过）
- Long-read 模式可以使用 UMI-tools 或 Picard 进行去重

## 更多信息

详细测试说明请参考 [TEST_EXAMPLES.md](TEST_EXAMPLES.md)
